<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="fire-crypto-base-behaviour.html">

<!--
`fire-crypto-verify`
Polymer Element fire-crypto-verify

@demo demo/index.html 
-->

<dom-module id="fire-crypto-verify">

    <script>
        Polymer({

            is: 'fire-crypto-verify',

            behaviors: [
                FiveElements.FireCryptoBaseBehavior
            ],


            properties: {
                /**
                 * The JSON Web Keyfor the signature
                 */
                jwk: {
                    type: Object
                },
                /**
                 * The signature
                 */
                signature: {
                    type: Object,

                },
                /**
                 * The data used for the signature
                 */
                data: {
                    type: Object
                },
                /**
                 * Is a Valid signature
                 */
                isVerify: {
                    type: Boolean,
                    notify: true
                }

            },

            observers: [
                '_verifySignObserver(jwk, data.*, signature)'
            ],

            // --- Verify Observer
            // --- ---------------------------
            _verifySignObserver: function (jwk, dataChanged, signature) {
                return this._verifySign(jwk, this.data, signature);
            },

            // --- API Verify
            // --- ---------------------------

            verifySign: function () {
                return this._verifySign(this.jwk, this.data, this.signature);
            },


            // --- Verify
            // --- ---------------------------
            /**
             * returns a Promise of a Boolean value indicating if the signature given as parameter matches the text, algorithm and key also given as parameters.
             * @param jwk The JSON Web Key
             * @param data The Data used for Sign
             * @param signature  The Signature
             * @returns {IPromise<R>} result is a Promise that returns a Boolean indicating if the signature has been a success on success.
             * @private
             */
            _verifySignPromise: function (jwk, data, signature) {
                var self = this;
                var cryptoSubtle = this._getCryptoSubtle();
                var algoJwk = undefined;
                var promise = this.getAlgorithmIdentifierFromJwtPromise(jwk)
                        .then(function (algo) {
                            algoJwk = algo;
                            return cryptoSubtle.importKey('jwk', jwk, algo, true, ['verify']);
                        }).then(function (keyBuffer) {
                            var signatureBuffer = self.hexToBuffer(signature);
                            var dataBuffer = self._convertDataToBuffer(data);
                            return cryptoSubtle.verify(algoJwk, keyBuffer, signatureBuffer, dataBuffer);
                        });
                return promise;
            },

            _verifySign: function (jwk, data, signature) {
                var self = this;
                // console.log('data to verify', data, signature);
                var verifyPromise = this._verifySignPromise(jwk, data, signature)
                        .then(function (isValid) {
                            self.isVerify = isValid;
                            self._fireCryptoKeyVerify(isValid, signature);
                            return isValid;
                        })
                        .catch(function (err) {
                            self.isVerify = false;
                            self._fireCryptoKeyVerify(false, signature);
                            self._fireCryptoKeyVerifyError(err, signature);
                        });
                return verifyPromise;
            },

            // --- Event Verify
            // --- ---------------------------

            /**
             * Fired when a Data is verify for the JWK.
             *
             * @event key-verify
             */
            _fireCryptoKeyVerify: function (isValid, signature) {
                console.log('isValid', isValid, ' for signature', signature);
                this.fire('key-verify', {isValid: isValid, signature: signature});
            },

            /**
             * Fired when an error occur in verify signature.
             *
             * @event error-key-verify
             */
            _fireCryptoKeyVerifyError: function (error, signature) {
                console.error('verify error' , error, ' for signature', signature);
                this.fire('error-key-verify', {error: error, signature: signature});
            },

        });
    </script>
</dom-module>