<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="fire-crypto-base-behaviour.html">

<!--
`fire-crypto-verify`
Polymer Element fire-crypto-verify

@demo demo/index.html 
-->

<dom-module id="fire-crypto-verify">

    <script>
        Polymer({

            is: 'fire-crypto-verify',

            behaviors: [
                FiveElements.FireCryptoBaseBehavior
            ],

            properties: {
                jwk: {
                    type: Object
                },
                signature: {
                    type: Object,

                },
                data: {
                    type: Object
                },
                isVerify: {
                    type: Boolean,
                    notify: true
                }

            },

            observers: [
                '_verifySignObserver(jwk, data.*, signature)'
            ],

            // --- Verify Observer
            // --- ---------------------------
            _verifySignObserver: function (jwk, dataChanged, signature) {
                return this._verifySign(jwk, this.data, signature);
            },

            // --- API Verify
            // --- ---------------------------

            verifySign: function () {
                return this._verifySign(this.jwk, this.data, this.signature);
            },


            // --- Verify
            // --- ---------------------------
            _verifySignPromise: function (jwk, data, signature) {
                var self = this;
                var cryptoSubtle = this._getCryptoSubtle();
                var algoJwk = undefined;
                var promise = this.getAlgorithmIdentifierFromJwtPromise(jwk)
                        .then(function (algo) {
                            algoJwk = algo;
                            return cryptoSubtle.importKey('jwk', jwk, algo, true, ['verify']);
                        }).then(function (keyBuffer) {
                            var signatureBuffer = self.hexStringToByteArray(signature);
                            var dataBuffer = self._convertDataToBuffer(data);
                            return cryptoSubtle.verify(algoJwk, keyBuffer, signatureBuffer, dataBuffer);
                        });
                return promise;
            },

            _verifySign: function (jwk, data, signature) {
                var self = this;
                // console.log('data to verify', data, signature);
                var verifyPromise = this._verifySignPromise(jwk, data, signature)
                        .then(function (isValid) {
                            self.isVerify = isValid;
                            self._fireCryptoKeyVerify(isValid, signature);
                            return isValid;
                        })
                        .catch(function (err) {
                            self.isVerify = undefined;
                            self._fireCryptoKeyVerifyError(err, signature);
                        });
                return verifyPromise;
            },

            // --- Event Verify
            // --- ---------------------------

            _fireCryptoKeyVerify: function (isValid, signature) {
                console.log('isValid', isValid, ' for signature', signature);
                this.fire('key-verify', {isValid: isValid, signature: signature});
            },
            _fireCryptoKeyVerifyError: function (error, signature) {
                console.error(error, ' for signature', signature);
                this.fire('error-key-verify', {error: error, signature: signature});
            },

        });
    </script>
</dom-module>