<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="fire-crypto-base-behaviour.html">

<!--
`fire-crypto-sign`
Polymer Element fire-crypto-sign

@demo demo/index.html 
-->

<dom-module id="fire-crypto-sign">

    <script>
        Polymer({

            is: 'fire-crypto-sign',

            behaviors: [
                FiveElements.FireCryptoBaseBehavior
            ],



            properties: {
                /**
                 * The Json Web Key used for Sign the data.
                 */
                jwk: {
                    type: Object
                },
                /**
                 * The data to sign
                 */
                data: {
                    type: Object
                },
                /**
                 * The generated Signature.
                 */
                signature: {
                    type: Object,
                    notify: true
                }

            },

            observers: [
                '_signObserver(jwk,data.*)'
            ],

            // --- Verify Observer
            // --- ---------------------------
            _signObserver: function (jwk, dataChanged ) {
                return this._sign(jwk, this.data );
            },


            // --- API Sign
            // --- ---------------------------
            sign: function () {
                this._sign(this.jwk, this.data);
            },

            // --- Sign
            // --- ---------------------------
            _signPromise: function (jwk, data) {
                var self = this;
                var cryptoSubtle = this._getCryptoSubtle();
                var algoJwk =undefined;
                var promise = this.getAlgorithmIdentifierFromJwtPromise(jwk)
                        .then(function (algo) {
                            algoJwk = algo;
                            return cryptoSubtle.importKey('jwk', jwk, algo, false, ['sign']);
                        }).then(function (keyBuffer) {
                            var dataBuffer = self._convertDataToBuffer(data);
                            return cryptoSubtle.sign(algoJwk, keyBuffer, dataBuffer);
                        }).then(function (macBuffer) {
                            var macHex = self.bufferToHex(macBuffer);
                            return macHex;
                        });
                return promise;
            },


            _sign: function (jwk, data) {
                var self = this;
                var signPromise = this._signPromise(jwk, data);
                signPromise = signPromise.then(function (macHex) {
                    self.signature = macHex;
                    self._fireCryptoKeySign(macHex);
                    return macHex;
                }).catch(function (err) {
                    self.signature = undefined;
                    self._fireCryptoKeySignError(err);
                });
                return signPromise;
            },

            // --- Event Sign
            // --- ---------------------------
            /**
             * Fired when a Data is sign.
             *
             * @event fire-sign
             */
            _fireCryptoKeySign: function (signature) {
                console.log('sign with', signature);
                this.fire('fire-sign', {signature: signature});
            },
            /**
             * Fired when a Sign Error in sign.
             *
             * @event fire-error-sign
             */
            _fireCryptoKeySignError: function (error) {
                console.error('sign error', error);
                this.fire('fire-error-sign', {error: error});
            },
        });
    </script>
</dom-module>