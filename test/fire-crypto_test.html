<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>fire-crypto test</title>

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>

    <link rel="import" href="../fire-crypto-generatekey.html">
    <link rel="import" href="../fire-crypto-sign.html">
    <link rel="import" href="../fire-crypto-verify.html">
</head>
<body>
<test-fixture id="sign">
    <template is="dom-template">
        <fire-crypto-generatekey id="generator" not-auto algo="[[algo]]"
                                 private-key="{{privateKey}}"></fire-crypto-generatekey>
        <fire-crypto-sign id="signor" not-auto jwk="[[privateKey]]" data="[[data]]"
                          signature="{{signature}}"></fire-crypto-sign>
        <fire-crypto-verify id="verifyor" not-auto jwk="[[privateKey]]" data="[[data]]"
                            signature="[[signature]]"></fire-crypto-verify>
    </template>
</test-fixture>

<test-fixture id="encrypt">
    <template is="dom-template">
        <fire-crypto-generatekey id="encryptGenerator" not-auto algo="[[algo]]"
                                keys="{{jwks}}"></fire-crypto-generatekey>
        <fire-crypto-encrypt id="encrypter" not-auto jwk="[[jwks]]" data="[[data]]"
                             ciphertext="{{ciphertext}}"></fire-crypto-encrypt>
        <fire-crypto-decrypt id="decrypter" not-auto jwk="[[jwks]]" data="{{decryptedData}}"
                             ciphertext="[[ciphertext]]"></fire-crypto-decrypt>
    </template>
</test-fixture>

<script>

    suite('Encrypt & Decrypt', function () {

        test('Bindings between Elements', function () {
            var element = fixture('encrypt', {
                algo:  {kty: "RSA", alg: "RSA-OAEP-512"},
                usages: ['encrypt', 'decrypt'],
                data: {title: 'Hello Wolrd!'}
            });
            var generator = document.getElementById('encryptGenerator');
            var encrypter = document.getElementById('encrypter');
            var decrypter = document.getElementById('decrypter');
            return generator.generateCryptoKey().then(function (keys) {
                assert.isOk(keys);
                assert.isOk(keys.privateKey);
                assert.isOk(keys.publicKey);
                assert.equal(generator.privateKey, keys.privateKey);
                assert.equal(generator.publicKey, keys.publicKey);
                return encrypter.encrypt();
            }).then(function (ciphertext) {
                assert.isOk(ciphertext);
                assert.equal(encrypter.ciphertext, ciphertext);
                return decrypter.decrypt();
            }).then(function (decryptedData) {
                assert.isTrue(decryptedData);
                assert.equal(decrypter.data, decryptedData);
                return decryptedData;
            });
        });


//        test('All Promise Sign Algo', function () {
//            var element = fixture('sign');
//            var data=  {title: 'Hello Wolrd!'};
//            var generator = document.getElementById('generator');
//            var signor = document.getElementById('signor');
//            var verifyor = document.getElementById('verifyor');
//            // Test
//            var signAlgo = generator.getAlgorithmsForSign();
//            var promiseArray= signAlgo.map(function (algo) {
//                return generator._generateCryptoKeyPromise(algo, true, ['sign', 'verify']).then(function (keys) {
//                    assert.isOk(keys);
//                    return signor._signPromise(keys.privateKey, data).then(function (signature) {
//                        return signature;
//                    }).then(function (signature) {
//                        assert.isOk(signature);
//                        var jwk = keys.publicKey ||keys.privateKey;
//                        return verifyor._verifySignPromise(jwk, data, signature);
//                    }).then(function (isVerify) {
//                        assert.isTrue(isVerify);
//                        return isVerify;
//                    });
//                });
//            });
//            return Promise.all(promiseArray);
//        });
    });



    suite('Sign & Verify', function () {
//        var generator;
//        var signor;
//        var verifyor;
//        setup(function () {
//            generator = document.getElementById('generator');
//            signor = document.getElementById('signor');
//            verifyor = document.getElementById('verifyor');
        // Check Elements
//            assert.isOk(generator);
//            assert.isOk(signor);
//            assert.isOk(verifyor);
//        });

        test('Bindings between Elements', function () {
            var element = fixture('sign', {
                algo: {name: "HMAC", hash: {name: "SHA-256"}},
                usages: ['sign', 'verify'],
                data: {title: 'Hello Wolrd!'}
            });
            var generator = document.getElementById('generator');
            var signor = document.getElementById('signor');
            var verifyor = document.getElementById('verifyor');
            return generator.generateCryptoKey().then(function (keys) {
                assert.isOk(keys);
                assert.isOk(keys.privateKey);
                assert.equal(generator.privateKey, keys.privateKey);
                assert.equal(generator.publicKey, keys.publicKey);
                return signor.sign();
            }).then(function (signature) {
                assert.isOk(signature);
                assert.equal(signor.signature, signature);
                return verifyor.verifySign();
            }).then(function (isVerify) {
                assert.isTrue(isVerify);
                assert.equal(verifyor.isVerify, isVerify);
                return isVerify;
            });
        });


        test('All Promise Sign Algo', function () {
            var element = fixture('sign');
            var data=  {title: 'Hello Wolrd!'};
            var generator = document.getElementById('generator');
            var signor = document.getElementById('signor');
            var verifyor = document.getElementById('verifyor');
            // Test
            var signAlgo = generator.getAlgorithmsForSign();
            var promiseArray= signAlgo.map(function (algo) {
                return generator._generateCryptoKeyPromise(algo, true, ['sign', 'verify']).then(function (keys) {
                    assert.isOk(keys);
                    return signor._signPromise(keys.privateKey, data).then(function (signature) {
                        return signature;
                    }).then(function (signature) {
                        assert.isOk(signature);
                        var jwk = keys.publicKey ||keys.privateKey;
                        return verifyor._verifySignPromise(jwk, data, signature);
                    }).then(function (isVerify) {
                        assert.isTrue(isVerify);
                        return isVerify;
                    });
                });
            });
            return Promise.all(promiseArray);
        });
    });



</script>
</body>
</html>
