<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="fire-crypto-base-behaviour.html">

<!--
`fire-crypto-encrypt`
Polymer Element fire-crypto-encrypt

@demo demo/index.html 
-->

<dom-module id="fire-crypto-decrypt">
    <script>
        Polymer({

            is: 'fire-crypto-decrypt',

            behaviors: [
                FiveElements.FireCryptoBaseBehavior
            ],

            properties: {
                /**
                 * Not Start decryption automatically when data changed
                 */
                notAuto: {
                    type: Boolean,
                    value: false
                },
                /**
                 * hex, base64, utf8, binaryString
                 */
                cryptoFormat: {
                    type: String,
                    value: 'base64'
                },
                /**
                 * Assume that the data is String. Not Apply JSON.stringly in crypto process.
                 */
                isDataString: {
                    type: Boolean,
                    value: false,
                },
                /**
                 * The Json Web Key used for Sign the data.
                 */
                jwk: {
                    type: Object
                },
                /**
                 * The cypher text text to decrypt
                 */
                ciphertext: {
                    type: String
                },
                /**
                 * The data to sign
                 */
                data: {
                    type: Object,
                    notify: true
                },
            },

            observers: [
                '_decryptObserver(notAuto,jwk,ciphertext)'
            ],

            // --- decrypt Observer
            // --- ---------------------------
            _decryptObserver: function (notAuto, jwk, ciphertext) {
                if (!notAuto) {
                    this._decrypt(jwk, ciphertext);
                }
            },

            // --- API decrypt
            // --- ---------------------------
            decrypt: function () {
                return this._decrypt(this.jwk, this.ciphertext);
            },



            // --- Decrypt
            // --- ---------------------------
            _configureAlgoParam: function(algo, cipherparam){
                var param = algo;
                if (cipherparam) {
                    // clone
                    param = JSON.parse(JSON.stringify(algo));
                    // copy properties
                    var keys = Object.keys(cipherparam);
                    keys.forEach(function (key) {
                       param[key] = cipherparam[key];
                    });
                }
                return param;
            },

            _decryptPromise: function (jwkeys, ciphertext) {
                var self = this;
                var jwk = jwkeys.privateKey || jwkeys;
                return this.importKeyJwkPromise(jwk, false, ['decrypt']).then(function (algoKey) {
                    var cryptoSubtle = self._getCryptoSubtle();
                    var cipherBuffer = self.cryptoBufferDeserialize(ciphertext, self.cryptoFormat, true);
                    var cipherparam = undefined; // TODO
                    var algo =  self._configureAlgoParam(algoKey.algo, cipherparam);
                    return cryptoSubtle.decrypt(algo, algoKey.key, cipherBuffer);
                }).then(function (clearbuffer) {
                    var decodedData = self.cryptoBufferSerialize(clearbuffer, 'utf8', self.isDataString);
                    return decodedData;
                });
            },


            _decrypt: function (jwk, ciphertext) {
                var self = this;
                return this._decryptPromise(jwk, ciphertext).then(function (decodedData) {
                    self.data = decodedData;
                    self._fireCryptoKeyDecrypt(decodedData);
                    return decodedData;
                }).catch(function (err) {
                    self.data = undefined;
                    self._fireCryptoKeyDecryptError(err);
                });
            },

            // --- Event Sign
            // --- ---------------------------
            /**
             * Fired when a Data is decrypted.
             *
             * @event fire-decrypt
             */
            _fireCryptoKeyDecrypt: function (decodedData) {
                console.log('fire-decrypt', decodedData);
                this.fire('fire-decrypt', {decrypt: decodedData});
            },
            /**
             * Fired when a Sign Error in decrypted.
             *
             * @event fire-error-decrypt
             */
            _fireCryptoKeyDecryptError: function (error) {
                console.error('fire-error-decrypt', error);
                this.fire('fire-error-decrypt', {error: error});
            },

        });
    </script>
</dom-module>