<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="fire-crypto-base-behaviour.html">

<!--
`fire-crypto-generatekey`
Polymer Element fire-crypto-generatekey

@demo demo/index.html 
-->

<dom-module id="fire-crypto-generatekey">
    <script>
        Polymer({

            is: 'fire-crypto-generatekey',

            behaviors: [
                FiveElements.FireCryptoBaseBehavior
            ],

            properties: {
                algo: {
                    type: Object,
                    value: function () {
                        // https://w3c.github.io/webcrypto/Overview.html#jwk-mapping
                        //can be 'SHA-1', 'SHA-256', 'SHA-384', or 'SHA-512'
                        return {name: "HMAC", hash: {name: "SHA-256"}};
                        //return { name: "ECDSA",  namedCurve: "P-256", hash: { name: "SHA-256" } }
                    }
                },
                // can be 'raw', 'pkcs8', 'spki', 'jwk'
                keyFormat: {
                    type: String,
                    value: 'jwk'
                },
                usages: {
                    type: Array,
                    value: function () {
                        return ['sign', 'verify'];
                    }
                },
                extractable: {
                    type: Boolean,
                    value: true
                },
                jwk: {
                    type: Object,
                    notify: true
                }

            },

            observers: [
                '_generateCryptoKeyObserver(algo, extractable, usages.splices)'
            ],

            // --- Observer Generate Key
            // --- ---------------------------
            _generateCryptoKeyObserver: function (algo, extractable, usages) {
                return this._generateCryptoKey(this.algo, this.extractable, this.usages);
            },

            // --- Api Generate Key
            // --- ---------------------------

            generateCryptoKey: function () {
               return this._generateCryptoKey(this.algo, this.extractable, this.usages);
            },


            // --- Key generation
            // --- ---------------------------
            _generateCryptoKeyPromise: function (algo, extractable, usages) {
                var cryptoSubtle = this._getCryptoSubtle();
                var promise = cryptoSubtle.generateKey(algo, extractable, usages);
                promise = promise.then(function (key) {
                    return cryptoSubtle.exportKey('jwk', key);
                });
                return promise;
            },

            _generateCryptoKey: function (algo, extractable, usages) {
                var self = this;
                var keyPromise = this._generateCryptoKeyPromise(algo, extractable, usages);
                keyPromise.then(function (key) {
                    console.log('_generateCryptoKey', JSON.stringify(key));
                    self.jwk = key;
                    self._fireCryptoKeyGen(key);
                    return key;
                }).catch(function (err) {
                    self.key = undefined;
                    self._fireCryptoKeyGenError(err);
                });
                return keyPromise;
            },

            // --- Event Generate Key
            // --- ---------------------------

            _fireCryptoKeyGen: function (key) {
                this.fire('key-gen', {jwk: key});
            },
            _fireCryptoKeyGenError: function (error) {
                console.error(error);
                this.fire('error-key-gen', {error: error});
            },

        });
    </script>
</dom-module>