<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="fire-crypto-base-behaviour.html">

<!--
`fire-crypto-generatekey`
Polymer Element fire-crypto-generatekey

@demo demo/index.html 
-->

<dom-module id="fire-crypto-generatekey">
    <script>
        Polymer({

            is: 'fire-crypto-generatekey',

            behaviors: [
                FiveElements.FireCryptoBaseBehavior
            ],




            properties: {

                /**
                 *algo is a dictionary object defining the key generation function to use.
                 * Supported algo are: AES-CBC, AES-CTR, AES-GCM, RSA-OAEP, AES-KW, HMAC, RSASSA-PKCS1-v1_5, ECDSA, ECDH, and DH.
                 */
                algo: {
                    type: Object,
                    value: function () {
                        // https://w3c.github.io/webcrypto/Overview.html#jwk-mapping
                        //can be 'SHA-1', 'SHA-256', 'SHA-384', or 'SHA-512'
                        return {name: "HMAC", hash: {name: "SHA-256"}};
//                        return {name: "RSASSA-PKCS1-v1_5",
//                            modulusLength: 2048, //can be 1024, 2048, or 4096
//                            publicExponent: new Uint8Array([0x01, 0x00, 0x01]),
//                            hash: {name: "SHA-256"}};
//                        return { name: "ECDSA",  namedCurve: "P-256", hash: { name: "SHA-256" } }
                    }
                },
                /**
                 * The usage of th key.
                 * Usages is an Array of Possible values ['encrypt', 'decrypt', 'sign', 'verify', 'deriveKey', 'deriveBits', 'wrapKey', 'unwrapKey']
                 */
                usages: {
                    type: Array,
                    value: function () {
                        return ['sign', 'verify'];
                    }
                },
                /**
                 * extractable is a Boolean indicating if the key can be extracted from the CryptoKey object at a later stage.
                 */
                extractable: {
                    type: Boolean,
                    value: true
                },
                /**
                 * The generated Json Web Key.
                 */
                jwk: {
                    type: Object,
                    notify: true
                }

            },

            observers: [
                '_generateCryptoKeyObserver(algo, extractable, usages.splices)'
            ],

            // --- Observer Generate Key
            // --- ---------------------------
            _generateCryptoKeyObserver: function (algo, extractable, usages) {
                return this._generateCryptoKey(this.algo, this.extractable, this.usages);
            },

            // --- Api Generate Key
            // --- ---------------------------

            generateCryptoKey: function () {
               return this._generateCryptoKey(this.algo, this.extractable, this.usages);
            },


            // --- Key generation
            // --- ---------------------------
            _generateCryptoKeyPromise: function (algo, extractable, usages) {
                var cryptoSubtle = this._getCryptoSubtle();
                var promise = cryptoSubtle.generateKey(algo, extractable, usages);
                promise = promise.then(function (key) {
                    console.log('_generateCryptoKeyPromise', JSON.stringify(key))
                    // TODO if publicKey or privateKey ==> key.publicKey
                    return cryptoSubtle.exportKey('jwk', key);
                });
                return promise;
            },

            _generateCryptoKey: function (algo, extractable, usages) {
                var self = this;
                var keyPromise = this._generateCryptoKeyPromise(algo, extractable, usages);
                keyPromise.then(function (key) {
                    console.log('_generateCryptoKey', JSON.stringify(key));
                    self.jwk = key;
                    self._fireCryptoKeyGen(key);
                    return key;
                }).catch(function (err) {
                    self.key = undefined;
                    self._fireCryptoKeyGenError(err);
                });
                return keyPromise;
            },

            // --- Event Generate Key
            // --- ---------------------------
            /**
             * Fired when a JWK is generated.
             *
             * @event jwk-generated
             */
            _fireCryptoKeyGen: function (key) {
                this.fire('jwk-generated', {jwk: key});
            },
            /**
             * Fired when an error occur in JWK generation .
             *
             * @event error-jwk-generated
             */
            _fireCryptoKeyGenError: function (error) {
                console.error('generated Key error', error);
                this.fire('error-jwk-generated', {error: error});
            },

        });
    </script>
</dom-module>